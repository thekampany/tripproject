{% extends "base_generic.html" %}

{% block content %}
<h1>Edit Outline</h1>

<form method="post" id="outline-form">
    {% csrf_token %}
    {{ form.as_p }}

    <h2>Items</h2>
    {{ formset.management_form }}
    <table id="items-table">
        <thead>
            <tr>
                <th>Drag</th>
                <th>Seq</th>
                <th>Description - Overnight</th>
                <th>Lat Long</th>
                <th>Radius</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
        {% for item_form in formset %}
        <tr class="item-form outline-row">
            {{ item_form.id }}  
            <td class="drag-handle" style="cursor: move;vertical-align: top;">â‡…</td>

        <td style="vertical-align: top;">
            <input type="number" 
                   name="{{ item_form.sequence.html_name }}" 
                   value="{{ item_form.sequence.value }}" 
                   class="sequence-field" 
                   max="999" 
                   style="width: 40px;">
        </td>

        <!-- Description as single-line input -->
        <td>
            <input type="text" 
                   name="{{ item_form.description.html_name }}" 
                   value="{{ item_form.description.value|default:'' }}" 
                   style="width: 200px;"><br>
            <input type="text"
                   name="{{ item_form.overnightlocation.html_name }}"
                   value="{{ item_form.overnightlocation.value|default:'' }}"
                   style="width: 200px;text-align: right;">
        </td>

        <!-- Coordinates stacked -->
        <td>
            <input type="number" 
                   step="0.000001" 
                   name="{{ item_form.latitude.html_name }}" 
                   value="{{ item_form.latitude.value|default:0 }}" 
                   style="width: 100px;"><br>
            <input type="number" 
                   step="0.000001" 
                   name="{{ item_form.longitude.html_name }}" 
                   value="{{ item_form.longitude.value|default:0 }}" 
                   style="width: 100px;">
        </td>

        <!-- Radius -->
        <td style="vertical-align: top;">
            <input type="number" 
                   name="{{ item_form.radius.html_name }}" 
                   value="{{ item_form.radius.value|default:100 }}" 
                   style="width: 60px;">
        </td>
        <!-- Delete -->
        <td style="vertical-align: top;">
            {{ item_form.DELETE.as_hidden }}
            <button type="button" class="delete-row-btn">X</button>
            </td>

        </tr>
        {% endfor %}
        </tbody>
    </table>
    <br><br>
    <button type="button" id="add-item">+ Item</button>
    <button type="submit">Opslaan</button>
</form>
As soon as you know the dates for your trip, you can turn the outline into a trip.
<br>
{% if form.errors %}
  <pre>{{ form.errors }}</pre>
{% endif %}
{% if formset.errors %}
  <pre>{{ formset.errors }}</pre>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const table = document.querySelector("#items-table tbody");
    const totalForms = document.getElementById("id_items-TOTAL_FORMS");
    const addButton = document.getElementById("add-item");

    document.querySelectorAll(".delete-row-btn").forEach(function(btn) {
      btn.addEventListener("click", function() {
        let row = btn.closest(".item-form");
        let hiddenDelete = row.querySelector("input[type='checkbox'][name$='-DELETE']");
        if (hiddenDelete) {
          hiddenDelete.checked = true; // markeer voor delete
        }
        row.style.display = "none"; // verberg rij in UI
      });
    });

    addButton.addEventListener("click", () => {
        const currentFormCount = parseInt(totalForms.value);
        const newRow = table.querySelector(".item-form").cloneNode(true);

        newRow.querySelectorAll("input, textarea").forEach(input => {
            if (input.type === "checkbox" && input.name.includes("DELETE")) {
               input.checked = false;
            } else if (!input.name.includes("id")) {  
               input.value = "";
            }
        });

        let maxSeq = 0;
        table.querySelectorAll("input[name$='-sequence']").forEach(input => {
            const val = parseInt(input.value);
            if (!isNaN(val) && val > maxSeq) maxSeq = val;
        });

        newRow.querySelector("input[name$='-sequence']").value = maxSeq + 1;



        // Default values
        newRow.querySelector("input[name$='-sequence']").value = currentFormCount + 1;
        newRow.querySelector("input[name$='-radius']").value = 100;
        newRow.querySelector("input[name$='-latitude']").value = 0;
        newRow.querySelector("input[name$='-longitude']").value = 0;

        // Update indices
        newRow.innerHTML = newRow.innerHTML.replace(/items-(\d+)-/g, "items-" + currentFormCount + "-");

        table.appendChild(newRow);
        totalForms.value = currentFormCount + 1;
    });

    // Drag & drop
    new Sortable(table, {
        handle: ".drag-handle",
        animation: 150,
        onEnd: function () {
            const rows = table.querySelectorAll(".item-form");
            rows.forEach((row, index) => {
                const seqInput = row.querySelector("input[name$='-sequence']");
                if (seqInput) seqInput.value = index + 1;
            });
        }
    });
});
</script>
<p>&nbsp;</p>
<div>
<a href="{% url 'tripapp:tripoutline-list' %}">&larr; Tripoutlines</a>
</div>

{% endblock %}
