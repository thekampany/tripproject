{% load i18n %}
<!DOCTYPE html>
<html>
<head>
  <title>Edit Itinerary Idea</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    #map { height: 400px; }
    body { font-family: sans-serif; }
    .coords-box { margin-top: 10px; }
    .coords-box input { margin: 2px; }
    .coords-row { margin-bottom: 5px; }
    .coords-row input[type="number"] { width: 60px; }
    .coords-row input[type="text"] { width: 120px; }
    .export { margin-top: 10px; }
    textarea { width: 100%; height: 150px; }
  </style>
</head>
<body>


<strong>{% trans "Edit Itinerary Idea:" %} {{ idea.name }}</strong>

<div id="map"></div>
<p>&nbsp;</p>

<h3>Day Locations</h3>
<table border="0" id="daylocations-table">
  <thead>
    <tr>
      <th style="text-align:left;">Day</th>
      <th style="text-align:left;">Seq</th>
      <th style="text-align:left;">Description</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="daylocations-body"></tbody>
</table>

<h3>Night Locations</h3>
<table border="0" id="nightlocations-table">
  <thead>
    <tr>
      <th style="text-align:left;">Day</th>
      <th style="text-align:left;">Description</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="nightlocations-body"></tbody>
</table>

<p>&nbsp;</p>
<button id="saveBtn">{% trans "Save" %}</button>
<p>&nbsp;</p>
<div><a href="{% url 'tripapp:itineraryidea-list' %}" style="text-decoration: none;">&larr;{% trans "Itinerary Ideas" %}</a></div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
var map = L.map('map');
var bounds = [];
var circles = [];
var defaultRadius = 5000;
var lines = [];
window.overnightPolygons = [];

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);


var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
})
.on('markgeocode', function(e) {
    var latlng = e.geocode.center;
    var marker = L.marker(latlng).addTo(map);
    marker.on('click', function() {
        createCircle(latlng);
        updateAll();
    });
    map.setView(latlng, 12);
})
.addTo(map);


function createCircle(latlng, day_sequence, sequence, radius, description, overnightDesc, isNight) {
    var ll = Array.isArray(latlng)
        ? L.latLng(latlng[0], latlng[1])
        : L.latLng(latlng.lat, latlng.lng);

    var color = isNight ? 'orange' : 'blue';
    var circle = L.circle(ll, {
        radius: radius || defaultRadius,
        color: color,
        fillColor: color,
        fillOpacity: 0.5
    }).addTo(map);

    const tooltipNight = `
    <div style="text-align:center;"><strong>Night ${day_sequence}</strong><br>${overnightDesc || ""}</div>
    `;
    const tooltipDay = `
    <div style="text-align:center;"><strong>Day ${day_sequence}</strong><br>(${sequence}) ${description || ''}</div>
    `;

    if (isNight) {
        circle.bindTooltip(tooltipNight, {permanent: true, direction: 'center'}).openTooltip();
    } else {
        circle.bindTooltip(tooltipDay, {permanent: true, direction: 'center'}).openTooltip();
    }
    var tableBody = isNight ? document.getElementById('nightlocations-body') : document.getElementById('daylocations-body');
    var row = document.createElement('tr');

    if (isNight) {
        row.innerHTML = `
          <td><input type="number" class="day-seq" value="${day_sequence}" style="width:50px;"></td>
          <td><input type="text" class="overnight-input" value="${overnightDesc || ''}" style="width:150px;"></td>
          <td><button type="button" class="row-delete-btn">X</button></td>
        `;
    } else {
        row.innerHTML = `
          <td><input type="number" class="day-seq" value="${day_sequence}" style="width:50px;"></td>
          <td><input type="number" class="seq-input" value="${sequence}" style="width:50px;"></td>
          <td><input type="text" class="desc-input" value="${description || ''}" style="width:150px;"></td>
          <td><button type="button" class="row-delete-btn">X</button></td>
        `;
    }

    tableBody.appendChild(row);

    var c = {
        circle: circle,
        latlng: ll,
        day_sequence: parseInt(day_sequence) || 1,
        sequence: parseInt(sequence) || 0,
        radius: parseFloat(radius) || defaultRadius,
        description: description || "",
        overnightDesc: overnightDesc || "",
        isNight: !!isNight,
        row: row
    };

    row.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            c.day_sequence = parseInt(row.querySelector('.day-seq').value) || 1;
            if (!isNight) c.sequence = parseInt(row.querySelector('.seq-input').value) || 0;
            if (!isNight) c.description = row.querySelector('.desc-input').value;
            if (isNight) c.overnightDesc = row.querySelector('.overnight-input').value;
            updateAll();
        });
    });

    var deleteBtn = row.querySelector('.row-delete-btn');
    deleteBtn.addEventListener('click', function() {
        map.removeLayer(circle);
        row.parentNode.removeChild(row);
        circles = circles.filter(x => x !== c);
        updateAll();
    });

    circles.push(c);
    bounds.push(ll);
}

function convexHull(points) {
    points = points.slice().sort((a,b) => a.lat - b.lat || a.lng - b.lng);

    function cross(o, a, b) {
        return (a.lat - o.lat) * (b.lng - o.lng) - (a.lng - o.lng) * (b.lat - o.lat);
    }

    let lower = [];
    for (let p of points) {
        while (lower.length >= 2 && cross(lower[lower.length-2], lower[lower.length-1], p) <= 0) lower.pop();
        lower.push(p);
    }

    let upper = [];
    for (let i = points.length - 1; i >= 0; i--) {
        let p = points[i];
        while (upper.length >= 2 && cross(upper[upper.length-2], upper[upper.length-1], points[i]) <= 0) upper.pop();
        upper.push(points[i]);
    }

    upper.pop();
    lower.pop();
    return lower.concat(upper);
}

function drawLines() {
    lines.forEach(l => map.removeLayer(l));
    lines = [];
    var sorted = circles.slice().sort((a,b) => a.day_sequence - b.day_sequence || a.sequence - b.sequence);
    for (var i = 0; i < sorted.length - 1; i++) {
        var line = L.polyline([sorted[i].circle.getLatLng(), sorted[i+1].circle.getLatLng()], { color: 'green' }).addTo(map);
        lines.push(line);
    }
}

function drawOvernightPolygons() {
    // remove existing polygons
    window.overnightPolygons.forEach(p => map.removeLayer(p));
    window.overnightPolygons = [];

     var dayMap = {};
    circles.forEach(c => {
        if(!dayMap[c.day_sequence]) dayMap[c.day_sequence] = { day: [], night: null };
        if(c.isNight) dayMap[c.day_sequence].night = c;
        else dayMap[c.day_sequence].day.push(c);
    });

    console.log("DayMap:", dayMap); // debug

    Object.keys(dayMap).forEach(daySeq => {
        var group = dayMap[daySeq];
        var points = group.day.map(d => d.latlng);

        points.forEach(p => L.circleMarker(p, {radius:4, color:'purple'}).addTo(map));

        if(group.night && points.length >= 3) {
            // polygon around daylocations
            var hullPoints = convexHull(points).map(ll => [ll.lat, ll.lng]);
            var poly = L.polygon(hullPoints, {color:'orange', fillOpacity:0.4}).addTo(map);
            window.overnightPolygons.push(poly);
            console.log("Polygon drawn for day_sequence", daySeq, "with", points.length, "points");
        } else if(group.night && points.length > 0) {
            points.forEach(p => {
                var c = L.circle(p, {radius: defaultRadius, color:'orange', fillColor:'orange', fillOpacity:0.4}).addTo(map);
                window.overnightPolygons.push(c);
            });
            console.log("1-2 points: circles drawn for day_sequence", daySeq);
        } else if(group.night) {
            // no daylocations, overnight just a circle
            var c = group.night;
            var circle = L.circle(c.latlng, {
                radius: c.radius || defaultRadius,
                color: 'orange',
                fillColor: 'orange',
                fillOpacity: 0.5
            }).addTo(map);
            window.overnightPolygons.push(circle);
            console.log("No daylocations: overnight circle drawn for day_sequence", daySeq);
        }
    });
}

function updateAll() {
    drawLines();
    drawOvernightPolygons();
}


// --- add daylocations and overnightlocations ---
{% for day_entry in days %}
    {% for loc in day_entry.day_locations %}
        createCircle(
            [{{ loc.latitude }}, {{ loc.longitude }}],
            {{ day_entry.day_sequence }},
            {{ loc.sequence }},
            {{ loc.radius }},
            "{{ loc.description|escapejs }}",
            "",
            false
        );
    {% endfor %}
    {% if day_entry.overnightlocation %}
        createCircle(
            [{{ day_entry.overnightlocation.latitude }}, {{ day_entry.overnightlocation.longitude }}],
            {{ day_entry.day_sequence }},
            0,
            {{ day_entry.overnightlocation.radius }},
            "",
            "{{ day_entry.overnightlocation.description|escapejs }}",
            true
        );
    {% endif %}
{% endfor %}

if(bounds.length>0){
    map.fitBounds(bounds, {padding:[50,50]});
} else {
    map.setView([52.1,5.1],6);
}

map.on('click', function(e) {
    var latlng = e.latlng;
    var nextDay = circles.length > 0 
        ? Math.max(...circles.map(c => c.day_sequence)) + 1 
        : 1;

    createCircle(
        latlng,
        nextDay,   
        0,         
        defaultRadius,
        "",        
        "Overnight stay", 
        true       
    );

    updateAll();
});

updateAll();

// --- save ---
document.getElementById('saveBtn').addEventListener('click', function() {
    var items = circles.map(c => ({
        day_sequence: parseInt(c.day_sequence) || 1,
        sequence: parseInt(c.sequence) || 0,
        latitude: parseFloat(c.latlng.lat.toFixed(6)),
        longitude: parseFloat(c.latlng.lng.toFixed(6)),
        radius: parseFloat(c.radius) || defaultRadius,
        description: c.isNight ? (c.overnightDesc || c.description) : (c.description || ""),
        overnight: !!c.isNight
    }));

    console.log("Payload sent to backend:", JSON.stringify(items, null, 2));

    fetch("{% url 'tripapp:update_itineraryidea' idea.id %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        credentials: "same-origin",
        body: JSON.stringify({
            name: "{{ idea.name|escapejs }}",
            items: items
        })
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === "ok"){
           console.log("Update success:", data);
        } else {
            console.error("Error:", data);
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
    });
});
</script>


</body>
</html>
