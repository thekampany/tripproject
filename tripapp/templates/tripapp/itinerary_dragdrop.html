{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Itinerary clustering ‚Äì {{ itinerary_idea.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .draggable {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: .5rem;
      padding: .5rem .75rem;
      margin-bottom: .5rem;
      cursor: grab;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .dropzone {
      min-height: 80px;
      padding: .75rem;
      border: 2px dashed #ccc;
      border-radius: .5rem;
      background-color: #fafafa;
      transition: background-color .2s;
    }
    .dropzone.dragover {
      background-color: #e7f3ff;
      border-color: #007bff;
    }
    .day-card {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: .5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .overnight-wrapper {
      background: #fff;
      border: 1px dashed #bbb;
      border-radius: .5rem;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="p-3">
  <strong>{% trans "Create a Itinerary Idea by indicating day locations" %}</strong><br>
  {% trans "Step 2 - Cluster the activities into days" %}

  <div class="container-fluid">
    <h4 class="mb-4">Itinerary: {{ itinerary_idea.name }}</h4>

    <div class="row">
      <div class="col-md-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">{% trans "List of Activities / Locations" %}</h5>
          </div>
          <div class="card-body">
            <div id="unassigned" class="dropzone">
              {% for dayloc in unclustered_daylocations %}
                <div class="draggable" draggable="true"
                     data-id="{{ dayloc.id }}"
                     data-lat="{{ dayloc.latitude }}"
                     data-lng="{{ dayloc.longitude }}">
                  <strong>{{ dayloc.description|default:"(no description)" }}</strong><br>
                  <small>{{ dayloc.sequence }}</small>
                </div>
              {% empty %}
                <p class="text-muted small">{% trans "No unassigned daylocations" %}</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">{% trans "Projected Tripdays" %}</h5>
          <button id="addDayBtn" class="btn btn-sm btn-success">+ {% trans "Add Day" %}</button>
        </div>

        <div id="daysContainer" class="row flex-column">
          {% for day in itinerary_days %}
            <div class="col-12 day-wrapper mb-3">
              <div class="day-card dropzone" data-day-id="{{ day.id }}">
                <div class="day-header">
                  <h6>Day {{ day.day_sequence }}</h6>
                  <button type="button" class="btn btn-sm btn-outline-danger remove-day-btn">X</button>
                </div>
                <div class="day-activities mt-2">
                  {% for act in day.day_activities.all %}
                    <div class="draggable" draggable="true"
                         data-id="{{ act.id }}"
                         data-lat="{{ act.latitude }}"
                         data-lng="{{ act.longitude }}">
                      <strong>{{ act.description|default:"(no description)" }}</strong><br>
                      <small>{{ act.sequence }}</small>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% empty %}
            <p class="text-muted">{% trans "No days added yet." %}</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="mt-4 text-end">
      <button id="saveBtn" class="btn btn-primary">{% trans "Save" %}</button>
    </div>
  </div>

  <p>&nbsp;</p>
  <div><a href="{% url 'tripapp:itineraryidea-list' %}" style="text-decoration: none;">&larr;{% trans "Itinerary Ideas" %}</a></div>

<script>
let dragged = null;
let nextDayId = -1;

// --- Drag & Drop ---
function setupDraggables() {
  document.querySelectorAll('.draggable').forEach(d => {
    d.addEventListener('dragstart', e => {
      dragged = d;
      e.dataTransfer.effectAllowed = 'move';
    });
    d.addEventListener('dragend', () => dragged = null);
  });
}

function setupDropzones() {
  document.querySelectorAll('.dropzone').forEach(zone => {
    zone.addEventListener('dragover', e => {
      e.preventDefault();
      zone.classList.add('dragover');
    });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (dragged) {
        zone.querySelector('.day-activities')?.appendChild(dragged) || zone.appendChild(dragged);
        setupDraggables();
      }
    });
  });
}

// --- Day renumbering + overnight insert ---
function renumberDays() {
  const days = document.querySelectorAll('.day-card');
  days.forEach((dayCard, idx) => {
    const header = dayCard.querySelector('.day-header h6');
    header.textContent = `Day ${idx + 1}`;
  });

  // remove old overnights
  document.querySelectorAll('.overnight-wrapper').forEach(el => el.remove());

  // add new overnights 
  days.forEach((dayCard, idx) => {
    const nextDay = days[idx + 1];
    if (nextDay) {
      const overnight = document.createElement('div');
      overnight.classList.add('overnight-wrapper');
      overnight.innerHTML = `
        <label class="form-label fw-bold mb-1">Overnight location after Day ${idx + 1}</label>
        <div class="d-flex gap-2">
          <input type="text" class="form-control overnight-input"
                 data-prev-day-id="${dayCard.dataset.dayId}"
                 value="${dayCard.querySelector('.draggable strong')?.textContent || ''}"
                 placeholder="Enter overnight location name">
          <button type="button" class="btn btn-outline-danger btn-sm remove-overnight-btn">X</button>
        </div>
      `;
      nextDay.parentNode.insertBefore(overnight, nextDay);
    }
  });

  setupRemoveOvernightButtons();
}

// --- Add Day ---
document.getElementById('addDayBtn').addEventListener('click', () => {
  const container = document.getElementById('daysContainer');
  const newDayNum = document.querySelectorAll('.day-card').length + 1;

  const newDay = document.createElement('div');
  newDay.classList.add('col-12', 'day-wrapper', 'mb-3');
  newDay.innerHTML = `
    <div class="day-card dropzone" data-day-id="${nextDayId--}">
      <div class="day-header">
        <h6>Day ${newDayNum}</h6>
        <button type="button" class="btn btn-sm btn-outline-danger remove-day-btn">X</button>
      </div>
      <div class="day-activities mt-2"></div>
    </div>`;
  container.appendChild(newDay);
  setupDropzones();
  setupRemoveButtons();
  renumberDays();
});

// --- Remove Day ---
function setupRemoveButtons() {
  document.querySelectorAll('.remove-day-btn').forEach(btn => {
    btn.onclick = () => {
      const dayWrapper = btn.closest('.day-wrapper');
      const dayId = dayWrapper.querySelector('.day-card').dataset.dayId;
      const unassigned = document.getElementById('unassigned');

      // verplaats activiteiten
      dayWrapper.querySelectorAll('.draggable').forEach(act => unassigned.appendChild(act));

      // verwijder eventuele overnight box erna
      document.querySelectorAll(`.overnight-input[data-prev-day-id="${dayId}"]`)
        .forEach(input => input.closest('.overnight-wrapper').remove());

      dayWrapper.remove();
      renumberDays();
    };
  });
}

// --- Remove Overnight ---
function setupRemoveOvernightButtons() {
  document.querySelectorAll('.remove-overnight-btn').forEach(btn => {
    btn.onclick = () => {
      btn.closest('.overnight-wrapper').remove();
    };
  });
}

// --- Helper: gemiddelde lat/lon ---
function calculateAverageLatLon(dayCard) {
  const acts = dayCard.querySelectorAll('.day-activities .draggable');
  let sumLat = 0, sumLng = 0, count = 0;
  acts.forEach(act => {
    const lat = parseFloat(act.dataset.lat);
    const lng = parseFloat(act.dataset.lng);
    if (!isNaN(lat) && !isNaN(lng)) {
      sumLat += lat;
      sumLng += lng;
      count++;
    }
  });
  if (count === 0) return { lat: null, lng: null };
  return { lat: sumLat / count, lng: sumLng / count };
}

// --- Save ---
document.getElementById('saveBtn').addEventListener('click', function() {
  console.log("üíæ Save button clicked");

  const assignments = [];
  const overnightlocations = [];

  // Day assignments
  console.log("üìÖ Collecting day assignments...");
  document.querySelectorAll('.day-card').forEach((dayCard, dayIndex) => {
    const dayId = dayCard.dataset.dayId;
    console.log(`‚û°Ô∏è Processing day ${dayIndex + 1} (day_id=${dayId})`);
    const acts = dayCard.querySelectorAll('.day-activities .draggable');
    acts.forEach((act, seqIndex) => {
      const obj = {
        activity_id: act.dataset.id,
        day_id: dayId,
        day_sequence: dayIndex + 1,
        sequence: seqIndex + 1
      };
      assignments.push(obj);
      console.log(`   üß© Added assignment`, obj);
    });
  });

  // Unassigned activiteiten
  console.log("üì¶ Collecting unassigned activities...");
  document.querySelectorAll('#unassigned .draggable').forEach(act => {
    const obj = {
      activity_id: act.dataset.id,
      day_id: null,
      day_sequence: null,
      sequence: null
    };
    assignments.push(obj);
    console.log(`   üí§ Unassigned activity`, obj);
  });

  // Overnight locations
  console.log("üåô Collecting overnight locations...");
  document.querySelectorAll('.overnight-input').forEach(input => {
    const description = input.value.trim();
    const dayId = input.dataset.prevDayId;
    if (description) {
      const dayCard = document.querySelector(`.day-card[data-day-id="${dayId}"]`);
      const avg = calculateAverageLatLon(dayCard);
      const obj = {
        day_id: dayId,
        description: description,
        latitude: avg.lat,
        longitude: avg.lng
      };
      overnightlocations.push(obj);
      console.log(`   üè® Added overnight location`, obj);
    } else {
      console.log(`   ‚ö†Ô∏è Skipped overnight for day_id=${dayId} (empty description)`);
    }
  });

  const payload = {
    itinerary_id: {{ itinerary_idea.id }},
    assignments: assignments,
    overnightlocations: overnightlocations
  };

  console.log("üì¶ Final payload to send:", JSON.stringify(payload, null, 2));

  console.log("üöÄ Sending fetch request...");
  fetch("{% url 'tripapp:save_daylocation_assignments' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify(payload)
  })
  .then(resp => {
    console.log("üì• Response received:", resp);
    return resp.json();
  })
  .then(result => {
    console.log("‚úÖ Save result:", result);
    alert("Opgeslagen!");
  })
  .catch(err => {
    console.error("‚ùå Fout bij opslaan:", err);
    alert("Fout bij opslaan.");
  });
});



setupDraggables();
setupDropzones();
setupRemoveButtons();
renumberDays();
</script>
</body>
</html>
